<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        video { max-width: 100%; height: auto; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; transition: width 0.3s; }
        .file-info { margin: 10px 0; font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –≤ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö</h1>
        
        <div class="test-section">
            <h2>üìπ –ó–∞–ø–∏—Å—å —Å –∫–∞–º–µ—Ä—ã</h2>
            <video id="preview" muted autoplay></video>
            <br>
            <button id="startRecord">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
            <button id="stopRecord" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            <div id="recordingStatus" class="file-info"></div>
        </div>

        <div class="test-section">
            <h2>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h2>
            <input type="file" id="fileInput" accept="video/*">
            <div id="fileInfo" class="file-info"></div>
        </div>

        <div class="test-section">
            <h2>üì§ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h2>
            <div class="file-info">
                <strong>–ë—Ä–∞—É–∑–µ—Ä:</strong> <span id="browserInfo"></span><br>
                <strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> <span id="platformInfo"></span>
            </div>
            
            <button id="testSmallVideo">–¢–µ—Å—Ç –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –≤–∏–¥–µ–æ (&lt;10 —Å–µ–∫)</button>
            <button id="testLargeVideo">–¢–µ—Å—Ç –¥–ª–∏–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ (&gt;50MB)</button>
            <button id="generateTestVideo">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ</button>
            
            <div class="progress" style="display: none;" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <div class="test-section">
            <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        const browserInfo = getBrowserInfo();
        document.getElementById('browserInfo').textContent = browserInfo.name + ' ' + browserInfo.version;
        document.getElementById('platformInfo').textContent = navigator.platform;

        // API URLs
        const API_URLS = {
            leads: 'https://functions.poehali.dev/a119ce14-9a5b-40de-b18f-3ef1f6dc7484',
            chunkedUpload: 'https://functions.poehali.dev/00f46d6e-5445-4f13-8032-e95041773736'
        };

        let mediaRecorder;
        let recordedChunks = [];
        let stream;

        // –ó–∞–ø–∏—Å—å —Å –∫–∞–º–µ—Ä—ã
        document.getElementById('startRecord').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 }, 
                    audio: true 
                });
                
                const preview = document.getElementById('preview');
                preview.srcObject = stream;
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    updateFileInfo('recordingStatus', blob, '–ó–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ');
                };
                
                mediaRecorder.start();
                document.getElementById('startRecord').disabled = true;
                document.getElementById('stopRecord').disabled = false;
                document.getElementById('recordingStatus').innerHTML = 'üî¥ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
                
            } catch (error) {
                addTestResult('error', '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
            }
        });

        document.getElementById('stopRecord').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('startRecord').disabled = false;
                document.getElementById('stopRecord').disabled = true;
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                updateFileInfo('fileInfo', file, '–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª');
            }
        });

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('testSmallVideo').addEventListener('click', () => {
            const file = document.getElementById('fileInput').files[0] || getRecordedBlob();
            if (file) {
                testVideoUpload(file, '–ö–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ');
            } else {
                addTestResult('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ –≤–∏–¥–µ–æ');
            }
        });

        document.getElementById('testLargeVideo').addEventListener('click', () => {
            const file = document.getElementById('fileInput').files[0];
            if (file && file.size > 50 * 1024 * 1024) {
                testVideoUpload(file, '–î–ª–∏–Ω–Ω–æ–µ –≤–∏–¥–µ–æ (>50MB)');
            } else {
                addTestResult('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Ä–∞–∑–º–µ—Ä–æ–º –±–æ–ª—å—à–µ 50MB');
            }
        });

        document.getElementById('generateTestVideo').addEventListener('click', () => {
            generateTestVideo();
        });

        function getRecordedBlob() {
            if (recordedChunks.length > 0) {
                return new Blob(recordedChunks, { type: 'video/webm' });
            }
            return null;
        }

        function updateFileInfo(elementId, file, label) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const duration = file.duration || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            
            document.getElementById(elementId).innerHTML = `
                <strong>${label}:</strong><br>
                üìÅ –†–∞–∑–º–µ—Ä: ${sizeInMB} MB<br>
                üé¨ –¢–∏–ø: ${file.type}<br>
                ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${duration} —Å–µ–∫
            `;
        }

        async function testVideoUpload(file, testName) {
            const startTime = Date.now();
            addTestResult('info', `üöÄ –ù–∞—á–∏–Ω–∞—é —Ç–µ—Å—Ç "${testName}" (${(file.size / (1024 * 1024)).toFixed(2)} MB)`);
            
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0);

            try {
                const leadData = {
                    parentName: '–¢–µ—Å—Ç –†–æ–¥–∏—Ç–µ–ª—å',
                    childName: '–¢–µ—Å—Ç –†–µ–±–µ–Ω–æ–∫',
                    age: '5',
                    phone: '+7999888777'
                };

                if (file.size > 8 * 1024 * 1024) {
                    await testChunkedUpload(file, leadData, testName);
                } else {
                    await testStandardUpload(file, leadData, testName);
                }

                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                addTestResult('success', `‚úÖ ${testName} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞ ${duration} —Å–µ–∫`);

            } catch (error) {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                addTestResult('error', `‚ùå ${testName} –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞ ${duration} —Å–µ–∫: ${error.message}`);
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        async function testStandardUpload(file, leadData, testName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onloadend = async () => {
                    try {
                        const result = reader.result;
                        const base64Video = result.split(',')[1];
                        
                        const response = await fetch(API_URLS.leads, {
                            method: 'POST',
                            headers: {
                                'X-Auth-Token': 'test-token-for-upload-test',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: `${testName} —Ç–µ—Å—Ç –æ—Ç ${new Date().toLocaleDateString()}`,
                                comments: `–†–æ–¥–∏—Ç–µ–ª—å: ${leadData.parentName}, –†–µ–±–µ–Ω–æ–∫: ${leadData.childName}, –í–æ–∑—Ä–∞—Å—Ç: ${leadData.age}, –¢–µ–ª–µ—Ñ–æ–Ω: ${leadData.phone}`,
                                video_data: base64Video,
                                video_filename: 'test-video.mp4',
                                video_content_type: file.type
                            })
                        });

                        updateProgress(100);

                        if (response.ok) {
                            const data = await response.json();
                            resolve(data);
                        } else {
                            const error = await response.json();
                            reject(new Error(error.error || 'Upload failed'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('File reading failed'));
                reader.readAsDataURL(file);
            });
        }

        async function testChunkedUpload(file, leadData, testName) {
            // –ü—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
            const chunkSize = 5 * 1024 * 1024; // 5MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–∞
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const progress = ((i + 1) / totalChunks) * 100;
                updateProgress(progress);
            }
        }

        function generateTestVideo() {
            addTestResult('info', 'üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ...');
            
            // –°–æ–∑–¥–∞–Ω–∏–µ canvas –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream);
            const chunks = [];
            
            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                updateFileInfo('fileInfo', blob, '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ');
                addTestResult('success', '‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ');
            };
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
            let frame = 0;
            const animate = () => {
                ctx.fillStyle = `hsl(${frame % 360}, 70%, 50%)`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`–¢–µ—Å—Ç ${Math.floor(frame / 30)}s`, canvas.width / 2, canvas.height / 2);
                
                frame++;
                if (frame < 600) { // 20 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 30 FPS
                    requestAnimationFrame(animate);
                } else {
                    recorder.stop();
                }
            };
            
            recorder.start();
            animate();
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function addTestResult(type, message) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            
            if (ua.includes('Chrome') && !ua.includes('Edg')) {
                const match = ua.match(/Chrome\/(\d+)/);
                return { name: 'Chrome', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                const match = ua.match(/Version\/(\d+)/);
                return { name: 'Safari', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('YaBrowser')) {
                const match = ua.match(/YaBrowser\/(\d+)/);
                return { name: 'Yandex Browser', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Edg')) {
                const match = ua.match(/Edg\/(\d+)/);
                return { name: 'Edge', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Firefox')) {
                const match = ua.match(/Firefox\/(\d+)/);
                return { name: 'Firefox', version: match ? match[1] : 'Unknown' };
            }
            
            return { name: 'Unknown', version: 'Unknown' };
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            addTestResult('info', `üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ –≤ ${browserInfo.name} ${browserInfo.version}`);
            addTestResult('info', 'üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ' + navigator.platform);
            addTestResult('info', 'üé• –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MediaRecorder: ' + (typeof MediaRecorder !== 'undefined' ? '–î–∞' : '–ù–µ—Ç'));
        });
    </script>
</body>
</html>