<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé• –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .browser-info { background: #e7f3ff; border: 1px solid #007acc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        video { max-width: 300px; height: auto; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        .progress { width: 100%; height: 25px; background: #f0f0f0; border-radius: 12px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .file-info { margin: 10px 0; font-size: 14px; color: #666; background: white; padding: 10px; border-radius: 4px; border: 1px solid #e0e0e0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stats { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .record-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .timer { font-size: 18px; font-weight: bold; color: #dc3545; }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .test-scenario { background: white; border-left: 4px solid #007bff; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ</h1>
        
        <div class="browser-info">
            <h3>üåê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ</h3>
            <strong>–ë—Ä–∞—É–∑–µ—Ä:</strong> <span id="browserInfo"></span><br>
            <strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> <span id="platformInfo"></span><br>
            <strong>User Agent:</strong> <span id="userAgent" style="font-size: 12px; color: #666;"></span><br>
            <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ MediaRecorder:</strong> <span id="mediaRecorderSupport"></span><br>
            <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ MIME —Ç–∏–ø—ã:</strong> <span id="supportedMimeTypes"></span>
        </div>

        <div class="grid">
            <div class="test-section">
                <h2>üìπ –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ</h2>
                <video id="preview" muted autoplay></video>
                <div class="record-controls">
                    <button id="startRecord">üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
                    <button id="stopRecord" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="recordShort">‚ö° –ó–∞–ø–∏—Å–∞—Ç—å 5 —Å–µ–∫</button>
                    <button id="recordLong">üé¨ –ó–∞–ø–∏—Å–∞—Ç—å 3 –º–∏–Ω</button>
                    <div class="timer" id="recordTimer">00:00</div>
                </div>
                <div id="recordingStatus" class="file-info"></div>
            </div>

            <div class="test-section">
                <h2>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h2>
                <input type="file" id="fileInput" accept="video/*">
                <div id="fileInfo" class="file-info">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª...</div>
                <button id="generateSmallVideo">üîß –°–æ–∑–¥–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —Ñ–∞–π–ª</button>
                <button id="generateLargeVideo">üîß –°–æ–∑–¥–∞—Ç—å –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h2>
            
            <div class="test-scenario">
                <h4>1Ô∏è‚É£ –ö–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ (&lt; 10 —Å–µ–∫—É–Ω–¥, &lt; 8MB)</h4>
                <button id="testShortChrome" class="test-btn" data-scenario="short">Chrome: —Ç–µ—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ</button>
                <button id="testShortSafari" class="test-btn" data-scenario="short">Safari: —Ç–µ—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ</button>
                <button id="testShortYandex" class="test-btn" data-scenario="short">–Ø–Ω–¥–µ–∫—Å: —Ç–µ—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ</button>
            </div>

            <div class="test-scenario">
                <h4>2Ô∏è‚É£ –î–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (2-3 –º–∏–Ω, 50+ MB)</h4>
                <button id="testLongChrome" class="test-btn" data-scenario="long">Chrome: —Ç–µ—Å—Ç –¥–ª–∏–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</button>
                <button id="testLongSafari" class="test-btn" data-scenario="long">Safari: —Ç–µ—Å—Ç –¥–ª–∏–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</button>
                <button id="testLongYandex" class="test-btn" data-scenario="long">–Ø–Ω–¥–µ–∫—Å: —Ç–µ—Å—Ç –¥–ª–∏–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</button>
            </div>

            <div class="test-scenario">
                <h4>3Ô∏è‚É£ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
                <button id="testAdminView">üë§ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
                <button id="testVideoPlayback">‚ñ∂Ô∏è –¢–µ—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</button>
            </div>
            
            <div class="progress" style="display: none;" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <div class="stats" id="testStats" style="display: none;">
                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤:</strong>
                <div id="statsContent"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
            <button id="clearResults" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            <button id="exportResults" class="success">üíæ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let recordingTimer;
        let recordingStartTime;
        let testStats = { total: 0, passed: 0, failed: 0 };

        // API URLs  
        const API_URLS = {
            leads: 'https://functions.poehali.dev/a119ce14-9a5b-40de-b18f-3ef1f6dc7484',
            chunkedUpload: 'https://functions.poehali.dev/00f46d6e-5445-4f13-8032-e95041773736',
            adminVideo: 'https://functions.poehali.dev/72f44b46-a11c-4ea3-addb-cb69aee5546e'
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            initializeBrowserInfo();
            setupEventListeners();
            addTestResult('info', 'üöÄ –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });

        function initializeBrowserInfo() {
            const browserInfo = getBrowserInfo();
            document.getElementById('browserInfo').textContent = browserInfo.name + ' ' + browserInfo.version;
            document.getElementById('platformInfo').textContent = navigator.platform;
            document.getElementById('userAgent').textContent = navigator.userAgent;
            document.getElementById('mediaRecorderSupport').textContent = typeof MediaRecorder !== 'undefined' ? '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö MIME —Ç–∏–ø–æ–≤
            const mimeTypes = ['video/webm', 'video/mp4', 'video/webm;codecs=vp9', 'video/webm;codecs=vp8'];
            const supported = mimeTypes.filter(type => MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type));
            document.getElementById('supportedMimeTypes').textContent = supported.length > 0 ? supported.join(', ') : '–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∏–ø–æ–≤';
        }

        function setupEventListeners() {
            // –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
            document.getElementById('startRecord').addEventListener('click', startRecording);
            document.getElementById('stopRecord').addEventListener('click', stopRecording);
            document.getElementById('recordShort').addEventListener('click', () => recordWithTimer(5));
            document.getElementById('recordLong').addEventListener('click', () => recordWithTimer(180));
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
            document.getElementById('fileInput').addEventListener('change', handleFileSelection);
            document.getElementById('generateSmallVideo').addEventListener('click', () => generateTestVideo(5, 'small'));
            document.getElementById('generateLargeVideo').addEventListener('click', () => generateTestVideo(180, 'large'));
            
            // –¢–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', (e) => runTestScenario(e.target.dataset.scenario));
            });
            
            // –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
            document.getElementById('testAdminView').addEventListener('click', testAdminPanel);
            document.getElementById('testVideoPlayback').addEventListener('click', testVideoPlayback);
            
            // –£—Ç–∏–ª–∏—Ç—ã
            document.getElementById('clearResults').addEventListener('click', clearResults);
            document.getElementById('exportResults').addEventListener('click', exportResults);
        }

        async function startRecording() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: true 
                });
                
                const preview = document.getElementById('preview');
                preview.srcObject = stream;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à–∏–π MIME —Ç–∏–ø
                let mimeType = 'video/webm';
                if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
                    mimeType = 'video/webm;codecs=vp9';
                } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
                    mimeType = 'video/webm;codecs=vp8';
                }
                
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    updateFileInfo('recordingStatus', blob, '–ó–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ');
                    stopTimer();
                };
                
                mediaRecorder.start(1000); // –î–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                startTimer();
                
                document.getElementById('startRecord').disabled = true;
                document.getElementById('stopRecord').disabled = false;
                
                addTestResult('success', 'üî¥ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                
            } catch (error) {
                addTestResult('error', '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('startRecord').disabled = false;
                document.getElementById('stopRecord').disabled = true;
                
                addTestResult('success', '‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            }
        }

        async function recordWithTimer(seconds) {
            await startRecording();
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                    addTestResult('info', `‚è±Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫—É–Ω–¥`);
                }
            }, seconds * 1000);
        }

        function startTimer() {
            recordingStartTime = Date.now();
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('recordTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (file) {
                updateFileInfo('fileInfo', file, '–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª');
                addTestResult('info', `üìÅ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`);
            }
        }

        function updateFileInfo(elementId, file, label) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const type = file.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            
            document.getElementById(elementId).innerHTML = `
                <strong>${label}:</strong><br>
                üìÅ <strong>–†–∞–∑–º–µ—Ä:</strong> ${sizeInMB} MB<br>
                üé¨ <strong>–¢–∏–ø:</strong> ${type}<br>
                üìÖ <strong>–ò–∑–º–µ–Ω–µ–Ω:</strong> ${file.lastModified ? new Date(file.lastModified).toLocaleString() : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
            `;
        }

        async function generateTestVideo(durationSec, size) {
            addTestResult('info', `üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${size === 'large' ? '–±–æ–ª—å—à–æ–≥–æ' : '–º–∞–ª–µ–Ω—å–∫–æ–≥–æ'} —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ (${durationSec} —Å–µ–∫)...`);
            
            const canvas = document.createElement('canvas');
            canvas.width = size === 'large' ? 1280 : 640;
            canvas.height = size === 'large' ? 720 : 480;
            const ctx = canvas.getContext('2d');
            
            const fps = size === 'large' ? 30 : 15;
            const stream = canvas.captureStream(fps);
            const recorder = new MediaRecorder(stream, {
                videoBitsPerSecond: size === 'large' ? 8000000 : 1000000 // 8Mbps –∏–ª–∏ 1Mbps
            });
            
            const chunks = [];
            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                updateFileInfo('fileInfo', blob, `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ ${size === 'large' ? '–±–æ–ª—å—à–æ–µ' : '–º–∞–ª–µ–Ω—å–∫–æ–µ'} –≤–∏–¥–µ–æ`);
                addTestResult('success', `‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${(blob.size / (1024 * 1024)).toFixed(2)} MB`);
            };
            
            let frame = 0;
            const totalFrames = durationSec * fps;
            
            const animate = () => {
                // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–æ—á–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
                const progress = frame / totalFrames;
                ctx.fillStyle = `hsl(${(frame * 2) % 360}, 70%, 50%)`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–≤–∏–∂—É—â–∏–µ—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã
                for (let i = 0; i < 10; i++) {
                    ctx.fillStyle = `hsl(${(frame * 3 + i * 36) % 360}, 80%, 60%)`;
                    const x = (Math.sin(frame * 0.1 + i) * canvas.width / 4) + canvas.width / 2;
                    const y = (Math.cos(frame * 0.08 + i) * canvas.height / 4) + canvas.height / 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 20 + Math.sin(frame * 0.2) * 10, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                ctx.fillStyle = 'white';
                ctx.font = `${size === 'large' ? '48px' : '24px'} Arial`;
                ctx.textAlign = 'center';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                const timeText = `${Math.floor(frame / fps)}s / ${durationSec}s`;
                ctx.strokeText(timeText, canvas.width / 2, canvas.height / 2);
                ctx.fillText(timeText, canvas.width / 2, canvas.height / 2);
                
                ctx.font = `${size === 'large' ? '24px' : '16px'} Arial`;
                ctx.fillText(`${size.toUpperCase()} VIDEO TEST`, canvas.width / 2, canvas.height / 2 + 60);
                
                frame++;
                if (frame < totalFrames) {
                    requestAnimationFrame(animate);
                } else {
                    recorder.stop();
                }
            };
            
            recorder.start();
            animate();
        }

        async function runTestScenario(scenario) {
            const browserInfo = getBrowserInfo();
            const startTime = Date.now();
            
            testStats.total++;
            updateStats();
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Ñ–∞–π–ª
            let videoFile = getVideoFile();
            if (!videoFile) {
                addTestResult('error', '‚ùå –ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
                testStats.failed++;
                updateStats();
                return;
            }
            
            const sizeInMB = videoFile.size / (1024 * 1024);
            const testName = `${scenario === 'short' ? '–ö–æ—Ä–æ—Ç–∫–æ–µ' : '–î–ª–∏–Ω–Ω–æ–µ'} –≤–∏–¥–µ–æ –≤ ${browserInfo.name}`;
            
            addTestResult('info', `üöÄ –ù–∞—á–∏–Ω–∞—é —Ç–µ—Å—Ç "${testName}" (${sizeInMB.toFixed(2)} MB)`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—é
            if (scenario === 'short' && sizeInMB > 8) {
                addTestResult('warning', '‚ö†Ô∏è –§–∞–π–ª –±–æ–ª—å—à–µ 8MB –¥–ª—è —Ç–µ—Å—Ç–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ');
            } else if (scenario === 'long' && sizeInMB < 50) {
                addTestResult('warning', '‚ö†Ô∏è –§–∞–π–ª –º–µ–Ω—å—à–µ 50MB –¥–ª—è —Ç–µ—Å—Ç–∞ –¥–ª–∏–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ');
            }
            
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0);

            try {
                const leadData = {
                    parentName: `–¢–µ—Å—Ç ${browserInfo.name}`,
                    childName: '–¢–µ—Å—Ç –†–µ–±–µ–Ω–æ–∫',
                    age: '5',
                    phone: '+7999888777'
                };

                if (sizeInMB > 8) {
                    await testChunkedUpload(videoFile, leadData, testName);
                } else {
                    await testStandardUpload(videoFile, leadData, testName);
                }

                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                addTestResult('success', `‚úÖ ${testName} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞ ${duration} —Å–µ–∫`);
                testStats.passed++;

            } catch (error) {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                addTestResult('error', `‚ùå ${testName} –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞ ${duration} —Å–µ–∫: ${error.message}`);
                testStats.failed++;
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
                updateStats();
            }
        }

        function getVideoFile() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0) {
                return fileInput.files[0];
            }
            
            // –ó–∞—Ç–µ–º –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
            if (recordedChunks.length > 0) {
                return new Blob(recordedChunks, { type: 'video/webm' });
            }
            
            return null;
        }

        async function testStandardUpload(file, leadData, testName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onloadend = async () => {
                    try {
                        const result = reader.result;
                        const base64Video = result.split(',')[1];
                        
                        updateProgress(50);
                        
                        const response = await fetch(API_URLS.leads, {
                            method: 'POST',
                            headers: {
                                'X-Auth-Token': 'test-token-for-upload-test',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: `${testName} —Ç–µ—Å—Ç –æ—Ç ${new Date().toLocaleDateString()}`,
                                comments: `–†–æ–¥–∏—Ç–µ–ª—å: ${leadData.parentName}, –†–µ–±–µ–Ω–æ–∫: ${leadData.childName}, –í–æ–∑—Ä–∞—Å—Ç: ${leadData.age}, –¢–µ–ª–µ—Ñ–æ–Ω: ${leadData.phone}`,
                                video_data: base64Video,
                                video_filename: `test-${Date.now()}.mp4`,
                                video_content_type: file.type
                            })
                        });

                        updateProgress(100);

                        if (response.ok) {
                            const data = await response.json();
                            resolve(data);
                        } else {
                            const error = await response.json();
                            reject(new Error(error.error || 'Upload failed'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('File reading failed'));
                reader.readAsDataURL(file);
            });
        }

        async function testChunkedUpload(file, leadData, testName) {
            const chunkSize = 5 * 1024 * 1024; // 5MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            const uploadId = 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            const initResponse = await fetch(API_URLS.chunkedUpload, {
                method: 'POST',
                headers: {
                    'X-Auth-Token': 'test-token-for-upload-test',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'start_upload',
                    upload_id: uploadId,
                    total_size: file.size,
                    total_chunks: totalChunks,
                    filename: `chunked-test-${Date.now()}.mp4`,
                    title: `${testName} —á–∞–Ω–∫–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞`,
                    comments: `–†–æ–¥–∏—Ç–µ–ª—å: ${leadData.parentName}, –†–µ–±–µ–Ω–æ–∫: ${leadData.childName}, –í–æ–∑—Ä–∞—Å—Ç: ${leadData.age}, –¢–µ–ª–µ—Ñ–æ–Ω: ${leadData.phone}`
                })
            });
            
            if (!initResponse.ok) {
                throw new Error('Chunked upload initialization failed');
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞–Ω–∫–æ–≤
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const base64Chunk = await blobToBase64(chunk);
                
                const chunkResponse = await fetch(API_URLS.chunkedUpload, {
                    method: 'POST',
                    headers: {
                        'X-Auth-Token': 'test-token-for-upload-test',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'upload_chunk',
                        upload_id: uploadId,
                        chunk_index: i,
                        chunk_data: base64Chunk
                    })
                });
                
                if (!chunkResponse.ok) {
                    throw new Error(`Chunk ${i + 1} upload failed`);
                }
                
                const progress = ((i + 1) / totalChunks) * 100;
                updateProgress(progress);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    const base64Data = result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function testAdminPanel() {
            addTestResult('info', 'üë§ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...');
            
            try {
                const response = await fetch(API_URLS.adminVideo + '?id=1', {
                    method: 'GET',
                    headers: {
                        'X-Auth-Token': 'test-admin-token'
                    }
                });
                
                if (response.ok) {
                    addTestResult('success', '‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞');
                } else {
                    addTestResult('warning', '‚ö†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                }
            } catch (error) {
                addTestResult('error', '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: ' + error.message);
            }
        }

        async function testVideoPlayback() {
            addTestResult('info', '‚ñ∂Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ...');
            
            const videoFile = getVideoFile();
            if (!videoFile) {
                addTestResult('error', '‚ùå –ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                return;
            }
            
            try {
                const videoUrl = URL.createObjectURL(videoFile);
                const video = document.createElement('video');
                video.src = videoUrl;
                video.controls = true;
                video.style.maxWidth = '300px';
                
                video.onloadedmetadata = () => {
                    addTestResult('success', `‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${video.duration.toFixed(1)}s, ${video.videoWidth}x${video.videoHeight}`);
                };
                
                video.onerror = () => {
                    addTestResult('error', '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const resultDiv = document.createElement('div');
                resultDiv.className = 'test-result info';
                resultDiv.innerHTML = `<strong>–¢–µ—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:</strong><br>`;
                resultDiv.appendChild(video);
                document.getElementById('testResults').appendChild(resultDiv);
                
            } catch (error) {
                addTestResult('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è URL –¥–ª—è –≤–∏–¥–µ–æ: ' + error.message);
            }
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
        }

        function updateStats() {
            const statsContainer = document.getElementById('testStats');
            const statsContent = document.getElementById('statsContent');
            
            statsContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; color: #007bff;">${testStats.total}</div>
                        <div>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; color: #28a745;">${testStats.passed}</div>
                        <div>–£—Å–ø–µ—à–Ω–æ</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; color: #dc3545;">${testStats.failed}</div>
                        <div>–û—à–∏–±–æ–∫</div>
                    </div>
                </div>
            `;
            
            statsContainer.style.display = testStats.total > 0 ? 'block' : 'none';
        }

        function addTestResult(type, message) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
            addTestResult('info', 'üóëÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
        }

        function exportResults() {
            const results = document.getElementById('testResults');
            const browserInfo = getBrowserInfo();
            
            let exportText = `–û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò –ó–ê–ì–†–£–ó–ö–ò –í–ò–î–ï–û\n`;
            exportText += `==============================================\n\n`;
            exportText += `–ë—Ä–∞—É–∑–µ—Ä: ${browserInfo.name} ${browserInfo.version}\n`;
            exportText += `–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${navigator.platform}\n`;
            exportText += `–î–∞—Ç–∞: ${new Date().toLocaleString()}\n`;
            exportText += `–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${testStats.total}\n`;
            exportText += `–£—Å–ø–µ—à–Ω–æ: ${testStats.passed}\n`;
            exportText += `–û—à–∏–±–æ–∫: ${testStats.failed}\n\n`;
            exportText += `–î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:\n`;
            exportText += `======================\n\n`;
            
            const resultElements = results.querySelectorAll('.test-result');
            resultElements.forEach(element => {
                exportText += element.textContent + '\n';
            });
            
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video-test-report-${browserInfo.name}-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addTestResult('success', 'üíæ –û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            
            if (ua.includes('Chrome') && !ua.includes('Edg') && !ua.includes('YaBrowser')) {
                const match = ua.match(/Chrome\/(\d+)/);
                return { name: 'Chrome', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                const match = ua.match(/Version\/(\d+)/);
                return { name: 'Safari', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('YaBrowser')) {
                const match = ua.match(/YaBrowser\/(\d+)/);
                return { name: 'Yandex Browser', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Edg')) {
                const match = ua.match(/Edg\/(\d+)/);
                return { name: 'Edge', version: match ? match[1] : 'Unknown' };
            } else if (ua.includes('Firefox')) {
                const match = ua.match(/Firefox\/(\d+)/);
                return { name: 'Firefox', version: match ? match[1] : 'Unknown' };
            }
            
            return { name: 'Unknown', version: 'Unknown' };
        }
    </script>
</body>
</html>